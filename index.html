<!DOCTYPE html>
<html>
<head>
    <title>NAVHunter v10 - Python Edition</title>
    <style>
        :root {
            --bg-main: #1a1a1d; --bg-panel: #2c2c34; --text-main: #e1e1e1;
            --text-muted: #8a8d93; --border-color: #444; --accent-blue: #4a90e2;
            --accent-amber: #e89f3c; --accent-red: #e74c3c; --accent-green: #2ecc71;
            --accent-purple: #6a44c1;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: var(--bg-main); color: var(--text-main); font-size: 14px; }
        #audio-prompt { position: fixed; top: 0; left: 0; width: 100%; background: var(--accent-amber); color: #000; text-align: center; padding: 5px; z-index: 9999; font-weight: bold; cursor: pointer; }
        .container { max-width: 1200px; margin: 0 auto; padding: 10px; }
        .panel { border: 1px solid var(--border-color); margin: 10px 0; padding: 15px; background: var(--bg-panel); border-radius: 8px; }
        .form-row { margin: 10px 0; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
        .form-row-column { flex-direction: column; align-items: flex-start; }
        .form-row label { display: inline-block; width: 120px; color: var(--text-muted); }
        .form-row input[type="number"], .form-row input[type="text"], .form-row input[type="password"], .form-row textarea { background: var(--bg-main); color: var(--text-main); border: 1px solid var(--border-color); padding: 8px; border-radius: 4px; flex: 1; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 5px 15px; padding-left: 0; }
        .checkbox-group label, .sub-label { margin: 0; cursor: pointer; display: flex; align-items: center; width: auto; font-size: 12px; }
        .checkbox-group input, .sub-label input { margin-right: 6px; }
        .btn { background: var(--accent-blue); color: #fff; border: none; padding: 10px 18px; cursor: pointer; margin: 5px; border-radius: 5px; font-weight: bold; transition: background 0.2s; }
        .btn:hover { background: #5a9ff2; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; background: #555; }
        .button-group { margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .alert { background: rgba(74, 144, 226, 0.1); padding: 15px; margin: 8px 0; border-radius: 8px; border: 1px solid var(--accent-blue); }
        .alert.alert-initial { border-color: var(--accent-amber); background: rgba(232, 159, 60, 0.1); box-shadow: 0 0 15px rgba(232, 159, 60, 0.2); }
        .alert-header { font-weight: bold; font-size: 16px; }
        .alert.alert-initial .alert-header { color: var(--accent-amber); }
        .alert-header .alert-delay { color: var(--text-main); font-size: 12px; margin-left: 15px; opacity: 0.8; }
        .alert-details { margin: 8px 0; font-size: 13px; line-height: 1.5; }
        .alert-details strong { color: var(--text-muted); }
        .alert-links a { color: var(--accent-blue); margin-right: 20px; font-weight: bold; text-decoration: none; }
        .alert-links a:hover { text-decoration: underline; }
        .console { position: fixed; bottom: 0; left: 0; right: 0; height: 200px; background: #111; border-top: 1px solid var(--border-color); padding: 10px; overflow-y: auto; font-size: 12px; }
        .side-panel { border: 1px solid var(--border-color); background: rgba(44, 44, 52, 0.7); backdrop-filter: blur(5px); padding: 10px; overflow-y: auto; font-size: 12px; z-index: 1000; border-radius: 8px; }
        .ai-terminal { position: fixed; top: 10px; right: 10px; width: 400px; height: calc(100vh - 20px); }
        .main-content { margin-right: 430px; margin-bottom: 220px; }
        .log-entry { margin: 2px 0; word-break: break-all; }
        .log-time { color: var(--text-muted); }
        .log-info { color: var(--text-main); }
        .log-error { color: var(--accent-red); }
        .log-warn { color: var(--accent-amber); }
        .log-skipped { color: var(--text-muted); }
        .stats { display: flex; gap: 20px; }
        .stat { text-align: center; }
        .stat-num { font-size: 20px; font-weight: bold; }
        .stat-label { font-size: 12px; color: var(--text-muted); }
        #log-details-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #log-details-modal { background: var(--bg-panel); width: 80vw; max-width: 1400px; height: 85vh; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 5px 25px rgba(0,0,0,0.5); position: relative; display: flex; flex-direction: column; }
        #modal-close-btn { position: absolute; top: 10px; right: 20px; font-size: 30px; color: var(--text-muted); cursor: pointer; transition: color 0.2s; }
        #modal-close-btn:hover { color: var(--text-main); }
        #modal-content-wrapper { overflow-y: auto; height: 100%; }
        .modal-section { margin-bottom: 20px; }
        .modal-section h4 { color: var(--accent-blue); margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .modal-section pre { white-space: pre-wrap; word-wrap: break-word; font-size: 12px; background: var(--bg-main); padding: 10px; border-radius: 4px; max-height: 35vh; overflow-y: auto; }
    </style>
</head>
<body>
    <div id="audio-prompt">Click anywhere on the page to enable audio and browser notifications.</div>
    <audio id="tts-audio" preload="auto"></audio>
    <audio id="ping-sound" preload="auto" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU9vT19AAAAA//8DAAAAAgABAAgABgAEAAIABQAGAAgABQADAAAAAgAAAAAAAAAAAAAAAAD//wIA/f8EAAEABgAEAAIABQAGAAgABQADAAAAAAAAAAAAAAD//wIA/f8EAAEABgAEAAIABQAGAAgABQADAAAAAAAAAAAAAAD//wIA/f8EAAEABgAEAAIABQAGAAgABQADAAAAAgAAAAAAAAAAAAAAAAD//wIA/f8EAAEABgAEAAIABQAGAAgABQADAAAAAAAAAAD//wEAAAAAAAD/AAABAAAAAQAAAAAAAQAAAAAAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAA-IBAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQAAAAEAAQ" ></audio>
    <div class="side-panel ai-terminal" id="aiTerminal"><h3 style="color: var(--accent-blue); margin-top:0;">🤖 AI Analysis Terminal</h3><div id="aiLog"><div style="color: var(--text-main);">[READY] ChatGPT-4o-mini configured.</div></div></div>
    <div class="main-content">
        <div class="container">
            <h1>NAVHunter v9</h1>
            <div class="panel"><h3>Crypto Treasury Alerts</h3><div id="alertsContainer">No alerts yet</div></div>
            <div class="panel">
                <h3>Configuration</h3>
                <div class="button-group">
                    <button class="btn" onclick="startMonitoring()" id="startBtn">▶ Start Real Time Detection</button>
                    <button class="btn" onclick="stopMonitoring()" id="stopBtn" disabled>■ Stop</button>
                    <button class="btn" onclick="replayLogFile()" id="replayBtn" style="background-color: var(--accent-purple);">⟳ Replay Log File</button>
                    <button class="btn" onclick="clearAlerts()" style="background-color: #555;">Clear Alerts</button>
                    <button class="btn" onclick="shutdownServer()" id="shutdownBtn" style="background-color: var(--accent-red);">Shutdown Server</button>
                    <button class="btn" onclick="requestNotificationPermission()" id="notifyBtn" style="background-color: var(--accent-green);">Enable Notifications</button>
                </div>
                <div class="form-row"><label>Confidence:</label><input type="number" id="confidence" value="65" min="0" max="100" style="width: 60px; flex: 0;"></div>
                <div class="form-row form-row-column">
                    <label style="margin-bottom: 10px;">Form Types:</label>
                    <div class="checkbox-group">
                        <label title="Standard corporate report of material events"><input type="checkbox" name="formType" value="8-K" checked> 8-K</label>
                        <label title="Quarterly corporate report"><input type="checkbox" name="formType" value="10-Q" checked> 10-Q</label>
                        <label title="Annual corporate report"><input type="checkbox" name="formType" value="10-K" checked> 10-K</label>
                        <label title="IPO registration statement"><input type="checkbox" name="formType" value="S-1"> S-1</label>
                        <label title="Prospectus for offerings"><input type="checkbox" name="formType" value="424B4"> 424B4</label>
                        <label title="Annual/Semi-annual fund report"><input type="checkbox" name="formType" value="N-CSR"> N-CSR</label>
                        <label title="Monthly fund portfolio holdings"><input type="checkbox" name="formType" value="N-PORT"> N-PORT</label>
                        <label title="Fund prospectus supplement"><input type="checkbox" name="formType" value="497"> 497</label>
                    </div>
                </div>
                <hr style="border-color: var(--border-color); margin: 15px 0;" />
                <div class="form-row"><label>Test Ticker:</label><input type="text" id="testTickerInput" placeholder="e.g., MSTR" style="text-transform: uppercase;"><button class="btn" onclick="runTickerTest()" id="testBtn">Test Ticker</button></div>
                <hr style="border-color: var(--border-color); margin: 20px 0 10px;" />
                <div class="form-row">
                    <label for="secApiKeyInput">SEC API Key:</label>
                    <input type="password" id="secApiKeyInput" value="" placeholder="Enter your SEC API key">
                </div>
                <div class="form-row">
                    <label for="openaiApiKeyInput">OpenAI API Key:</label>
                    <input type="password" id="openaiApiKeyInput" value="" placeholder="Enter your OpenAI API key">
                </div>
            </div>
            <div class="panel">
                <h3>🤖 AI Prompt & Tuning</h3>
                <div class="form-row"><label>Model:</label><input type="text" id="aiModel" value="gpt-4o-mini" style="flex-grow: 1;"><label style="width: auto; margin-left: 10px;">Temp:</label><input type="number" id="aiTemperature" value="0.1" min="0" max="2" step="0.1" style="width: 60px; flex: 0;"></div>
                <div class="form-row" style="flex-direction: column; align-items: stretch;"><label style="margin-bottom: 5px;">AI System Prompt:</label><textarea id="aiPromptTextarea" rows="15" style="width: 100%; box-sizing: border-box;"></textarea></div>
                <button class="btn" onclick="restoreDefaultPrompt()" style="background-color: #555;">Restore Default Prompt</button>
            </div>
            <div class="status" id="status">Status: Stopped</div>
            <div class="panel">
                <div class="stats">
                    <div class="stat"><div class="stat-num" id="processed">0</div><div class="stat-label">Processed</div></div>
                    <div class="stat"><div class="stat-num" id="alerts">0</div><div class="stat-label">Alerts</div></div>
                    <div class="stat"><div class="stat-num" id="uptime">00:00</div><div class="stat-label">Uptime</div></div>
                    <div class="stat"><div class="stat-num" id="wsStatus" style="color: var(--text-muted);">Off</div><div class="stat-label">Connection</div></div>
                </div>
            </div>
        </div>
    </div>
    <div class="console" id="console"><div class="log-entry log-info">System initialized. Click page to enable audio.</div></div>
    <div id="log-details-modal-overlay"><div id="log-details-modal"><span id="modal-close-btn">&times;</span><div id="modal-content-wrapper"><div class="modal-section"><h4>Request Sent to AI</h4><pre id="modal-request-content"></pre></div><div class="modal-section"><h4>Raw Response from AI</h4><pre id="modal-response-content"></pre></div></div></div></div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        let isMonitoring = false, startTime = null, processedCount = 0, alertCount = 0, wsFlashTimeout = null;
        let audioEnabled = false;
        let notificationsEnabled = false;

        const defaultPrompt = `You are an expert financial analyst AI. Your task is to analyze SEC filings for specific, user-defined events.

COMPANY: {company} ({ticker})
FORM TYPE: {formType}

First, analyze the filing to determine if it contains any relevant information according to the user's criteria. Your response MUST be a clean JSON object without any markdown.

**Primary Decision:**
- **isAlertWorthy** (boolean): This is the most important field.
    - Set to **true** ONLY if the filing contains a significant, actionable event that matches the user's criteria.
    - Set to **false** if the filing is routine, irrelevant, or does not contain any event of interest. **If this is false, no alert will be generated.**

**If and ONLY If isAlertWorthy is true, provide the following:**
1.  **isAlertWorthy** (boolean): Set to true ONLY if the filing contains information about crypto currencies or digital assets being added to the company's treasury, or if it is an initial pivot to a new strategy involving crypto assets. This should be a significant event that warrants immediate attention.
   - For example, if a company announces it is adopting Bitcoin as its primary treasury reserve asset, this should be marked as worthy of an alert.
   - If the filing is a routine update without significant changes to crypto holdings or strategy, set this to false.
2.  **confidenceScore** (integer, 0-100): Your confidence level in your understanding of setting the isAlertWorthy field. This should reflect how certain you are that the filing meets the criteria for an alert.
   - For example, if you are very confident that the filing is significant, set this to 90 or above. If you are unsure, set it lower.
   - If you set isAlertWorthy to true, confidenceScore should be at least 80.
3.  **alertHighlight** (boolean): Set to true if this is indeed an initial pivot to a new strategy involving crypto assets as treasury assets for the company, such as Bitcoin or Ethereum. This should be used to highlight the most significant changes in strategy.
   - For example, if a company is pivoting to focus on Bitcoin as its primary treasury asset, set this to true. Meaning the first time they are doing this.
   - If the filing is a routine update or does not represent a significant change, set this to false. If the update does not explictly mention a pivot to the purchase of crypto assets on the balance sheet, set this to false.
4.  **textToSpeak** (string): A concise, spoken-word summary of the alert for audio notification with ticket and relevant quote. Example: "Alert for M S T R. Initial strategy pivot. Quote: MicroStrategy has purchased an additional 12,000 bitcoins."
5. **isChinese** (boolean): Set to true if the filing is from a Chinese company, false otherwise. This is important for filtering out filings from companies that may not be relevant to the user's focus on US-based crypto treasury pivots.
6. **investors** (string): let me know the few key investors involved in this event
7. **RaiseOrAnnouncment** (String): If this is a actual raise or announcement (meaning the money is confirmed raised, not an announcment to raise), Then Say yes and give proof, otherwise Say No. This is important to distinguish between routine updates and significant events.


**A complete example response for an initial pivot:**
{
  "isAlertWorthy": true,
  "confidenceScore": 98,
  "alertHighlight": true,
  "isChinese": false,
  "investors": "Michael Saylor, Pantera Capital",
  "raiseOrAnnouncment": "Yes, this is actual funds raised based on Quote of 1 sentence"
  "textToSpeak": "Alert on ticker M S T R. Form 8-K. Initial strategy pivot. Quote: MicroStrategy adopts Bitcoin as its primary treasury reserve asset. Let me know if chinese",
  "Event Type": "Crypto Treasury Pivot",
  "Asset": "Bitcoin (BTC)",
  "Key Quote": "The board of directors has approved a new treasury reserve policy that makes bitcoin the company's primary treasury reserve asset."

**Example of an Irrelevant Filing (No Alert):**
{
  "isAlertWorthy": false
}`;

        const socket = io();
        socket.on('log_message', (data) => log(data.message, data.level));
        socket.on('ai_log_message', (data) => aiLog(data.message, data.level, data.details));
        socket.on('new_alert', (data) => handleNewAlert(data));
        socket.on('play_tts_audio', (data) => playTTSAudio(data.audioB64));
        socket.on('update_stats', (data) => { if (data.processed) { processedCount += data.processed; } updateStats(); });
        socket.on('monitoring_status', (data) => {
            isMonitoring = data.isMonitoring;
            document.getElementById('startBtn').disabled = isMonitoring;
            document.getElementById('stopBtn').disabled = !isMonitoring;
            document.getElementById('replayBtn').disabled = isMonitoring;
            document.getElementById('testBtn').disabled = isMonitoring;
            document.getElementById('shutdownBtn').disabled = isMonitoring;
            document.getElementById('notifyBtn').disabled = isMonitoring;
            if (isMonitoring) {
                startTime = Date.now();
                document.getElementById('status').textContent = 'Status: Connecting...';
            } else {
                startTime = null;
                document.getElementById('status').textContent = 'Status: Stopped';
                document.getElementById('wsStatus').textContent = 'Off';
                document.getElementById('wsStatus').style.color = 'var(--text-muted)';
                log('⏹ Monitoring stopped', 'info');
            }
        });
        socket.on('ws_status', (data) => {
            const wsStatus = document.getElementById('wsStatus');
            wsStatus.textContent = data.status;
            wsStatus.style.color = data.color;
            if (data.status === 'Live') { document.getElementById('status').textContent = 'Status: Connected - Streaming live filings'; }
        });
        socket.on('ws_status_flash', flashWsStatus);
        socket.on('test_ticker_finished', () => {
            document.getElementById('testBtn').disabled = isMonitoring; document.getElementById('testBtn').textContent = 'Test Ticker';
        });
        socket.on('replay_finished', () => {
            log('⟳ Replay complete.', 'warn');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('replayBtn').disabled = false;
            document.getElementById('testBtn').disabled = false;
            document.getElementById('shutdownBtn').disabled = false;
        });
        socket.on('server_shutting_down', (data) => {
            log(data.message, 'warn');
            document.getElementById('status').textContent = 'Status: Server has been shut down.';
            document.body.style.backgroundColor = 'var(--accent-red)';
        });


        function log(message, level = 'info') { const el = document.getElementById('console'), time = new Date().toLocaleTimeString(), entry = document.createElement('div'); entry.className = `log-entry log-${level}`; entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`; el.appendChild(entry); el.scrollTop = el.scrollHeight; if (el.children.length > 200) el.removeChild(el.firstChild); }
        function aiLog(message, level = 'info', details = null) { const el = document.getElementById('aiLog'), time = new Date().toLocaleTimeString(), entry = document.createElement('div'); let color = 'var(--text-main)'; if (level === 'analysis') color = 'var(--accent-blue)'; if (level === 'hit') color = 'var(--accent-amber)'; if (level === 'error') color = 'var(--accent-red)'; entry.style.color = color; entry.style.margin = '2px 0'; if (details) { entry.innerHTML = `[${time}] ${message} <span style="cursor: pointer; text-decoration: underline; color: var(--text-muted);">(Details)</span>`; entry.onclick = () => showLogDetailsModal(details); } else { entry.innerHTML = `[${time}] ${message}`; } el.appendChild(entry); el.scrollTop = el.scrollHeight; if (el.children.length > 100) el.removeChild(el.children[1]); }
        function showLogDetailsModal(details) { document.getElementById('modal-request-content').textContent = details.request; document.getElementById('modal-response-content').textContent = details.response; document.getElementById('log-details-modal-overlay').style.display = 'flex'; }
        function hideLogDetailsModal() { document.getElementById('log-details-modal-overlay').style.display = 'none'; }
        function updateStats() { document.getElementById('processed').textContent = processedCount; document.getElementById('alerts').textContent = alertCount; if ((isMonitoring || document.getElementById('replayBtn').disabled) && startTime) { const elapsed = Date.now() - startTime, minutes = Math.floor(elapsed / 60000), seconds = Math.floor((elapsed % 60000) / 1000); document.getElementById('uptime').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; } }
        function flashWsStatus() { const wsStatus = document.getElementById('wsStatus'); if (!wsStatus || !isMonitoring) return; if (wsFlashTimeout) clearTimeout(wsFlashTimeout); wsStatus.style.color = 'var(--text-main)'; wsStatus.textContent = 'Receiving'; wsFlashTimeout = setTimeout(() => { if (isMonitoring) { const currentStatus = wsStatus.textContent; if(currentStatus !== 'Error' && currentStatus !== 'Off') { wsStatus.style.color = 'var(--accent-green)'; wsStatus.textContent = 'Live'; } } }, 300); }
        function getSelectedFormTypes() { return Array.from(document.querySelectorAll('input[name="formType"]:checked')).map(cb => cb.value); }

        function handleNewAlert(data) {
            const { filing, aiAnalysis } = data;
            alertCount++;
            const alertsDiv = document.getElementById('alertsContainer');
            if (alertsDiv.innerHTML === 'No alerts yet') alertsDiv.innerHTML = '';

            const alertTime = new Date(), filedAtTime = new Date(filing.filedAt);
            let delayString = 'N/A';
            if (!isNaN(filedAtTime)) {
                const delayMs = alertTime.getTime() - filedAtTime.getTime();
                const totalSeconds = delayMs / 1000, minutes = Math.floor(totalSeconds / 60), seconds = (totalSeconds % 60).toFixed(1);
                delayString = `${minutes} min, ${seconds} sec`;
            }
            const formattedFiledAt = filedAtTime.toLocaleString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
            const tradingViewUrl = `https://www.tradingview.com/chart/?symbol=${filing.ticker}`;

            const alert = document.createElement('div');
            const isGoldAlert = aiAnalysis.alertHighlight === true;
            alert.className = isGoldAlert ? 'alert alert-initial' : 'alert';

            const header = `<div class="alert-header">${filing.companyName || 'Unknown'} (${filing.ticker || 'N/A'}) - ${aiAnalysis.confidenceScore}%<span class="alert-delay">(Delay: ${delayString})</span></div>`;

            let detailsHtml = '<div class="alert-details">';
            const functionalKeys = ['isAlertWorthy', 'confidenceScore', 'alertHighlight', 'textToSpeak'];
            for (const key in aiAnalysis) {
                if (aiAnalysis.hasOwnProperty(key) && !functionalKeys.includes(key)) {
                    const cleanKey = String(key).replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    const cleanValue = String(aiAnalysis[key]).replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    detailsHtml += `<strong>${cleanKey}:</strong> ${cleanValue}<br>`;
                }
            }
            detailsHtml += `<strong>Filing:</strong> ${filing.formType} &nbsp;&nbsp; <strong>Filed At:</strong> ${formattedFiledAt}<br>`;
            detailsHtml += '</div>';

            const links = `<div class="alert-links"><a href="${tradingViewUrl}" target="_blank">💹 TradingView</a><a href="${filing.linkToFilingDetails || filing.linkToHtml}" target="_blank">📄 SEC Filing</a></div>`;

            alert.innerHTML = header + detailsHtml + links;
            alertsDiv.insertBefore(alert, alertsDiv.firstChild);

            if (isGoldAlert) {
                log(`🔊 GOLD ALERT: ${filing.ticker} - Awaiting audio...`, 'warn');
            } else {
                playPing();
                log(`🔊 Blue Alert: ${filing.ticker}`, 'info');
            }

            if (notificationsEnabled && Notification.permission === 'granted') {
                const notifTitle = `${isGoldAlert ? 'GOLD' : 'Blue'} Alert: ${filing.ticker || 'N/A'}`;
                const notifBody = aiAnalysis.textToSpeak || `Confidence: ${aiAnalysis.confidenceScore}%`;
                new Notification(notifTitle, { body: notifBody, icon: 'https://www.google.com/s2/favicons?domain=sec.gov&sz=64' });
            }
            updateStats();
        }

        function playTTSAudio(audioB64) {
            if (audioEnabled && audioB64) {
                const audioPlayer = document.getElementById('tts-audio');
                audioPlayer.src = `data:audio/mp3;base64,${audioB64}`;
                audioPlayer.play().catch(error => console.error("Error playing TTS audio:", error));
            }
        }

        function playPing() {
            if (audioEnabled) {
                const pingPlayer = document.getElementById('ping-sound');
                pingPlayer.currentTime = 0;
                pingPlayer.play().catch(e => console.error("Error playing ping sound:", e));
            }
        }

        function getFullConfig() {
            return {
                formTypes: getSelectedFormTypes(),
                confidence: parseInt(document.getElementById('confidence').value, 10),
                aiModel: document.getElementById('aiModel').value,
                aiTemperature: parseFloat(document.getElementById('aiTemperature').value),
                aiPrompt: document.getElementById('aiPromptTextarea').value,
                secApiKey: document.getElementById('secApiKeyInput').value,
                openaiApiKey: document.getElementById('openaiApiKeyInput').value
            };
        }

        function startMonitoring() { socket.emit('start_monitoring', getFullConfig()); }
        function stopMonitoring() { socket.emit('stop_monitoring'); }
        function runTickerTest() {
            const tickerInput = document.getElementById('testTickerInput');
            const ticker = tickerInput.value.trim().toUpperCase();
            if (!ticker) { log('❌ Please enter a ticker to test.', 'error'); return; }
            document.getElementById('testBtn').disabled = true; document.getElementById('testBtn').textContent = 'Testing...';
            let config = getFullConfig();
            config.ticker = ticker;
            socket.emit('run_ticker_test', config);
        }
        function replayLogFile() {
            log('⟳ Starting replay from websocket_stream.log...', 'warn');
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('replayBtn').disabled = true;
            document.getElementById('testBtn').disabled = true;
            document.getElementById('shutdownBtn').disabled = true;
            startTime = Date.now();
            processedCount = 0; alertCount = 0;
            updateStats();
            socket.emit('replay_log_file', getFullConfig());
        }

        function shutdownServer() {
            if (confirm('Are you sure you want to shut down the entire backend server?')) {
                log('🔴 Sending shutdown command to server...', 'error');
                socket.emit('shutdown_server');
            }
        }

        function clearAlerts() { document.getElementById('alertsContainer').innerHTML = 'No alerts yet'; alertCount = 0; updateStats(); log('Alerts cleared.', 'info'); }
        function restoreDefaultPrompt() { document.getElementById('aiPromptTextarea').value = defaultPrompt; log('AI prompt restored to default.', 'info'); }

        function enableAudio() {
            if (audioEnabled) return;
            const ttsPlayer = document.getElementById('tts-audio');
            const pingPlayer = document.getElementById('ping-sound');

            // This is the most robust way to unlock audio in browsers.
            // Play both sounds muted, which satisfies the user-interaction requirement.
            ttsPlayer.muted = true;
            pingPlayer.muted = true;

            // We don't care about the result of the play promise, only that we tried.
            ttsPlayer.play().catch(() => {});
            pingPlayer.play().catch(() => {});

            // Unmute them for future use.
            ttsPlayer.muted = false;
            pingPlayer.muted = false;

            audioEnabled = true;
            document.getElementById('audio-prompt').style.display = 'none';
            log('Audio alerts enabled.', 'info');
        }

        function requestNotificationPermission() {
            if (typeof Notification === 'undefined') {
                log('This browser does not support desktop notifications.', 'error');
                return;
            }
            if (Notification.permission === 'granted') {
                log('Browser notifications are already enabled.', 'info');
                notificationsEnabled = true;
                return;
            }
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    notificationsEnabled = true;
                    log('Browser notifications enabled successfully.', 'info');
                    new Notification("NAVHunter", { body: "Notifications are now enabled!" });
                } else {
                    notificationsEnabled = false;
                    log('Browser notifications were denied.', 'warn');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('aiPromptTextarea').value = defaultPrompt;
            document.getElementById('modal-close-btn').onclick = hideLogDetailsModal;
            document.getElementById('log-details-modal-overlay').onclick = (event) => { if (event.target.id === 'log-details-modal-overlay') hideLogDetailsModal(); };
        });
        document.body.addEventListener('click', enableAudio, { once: true });
        setInterval(updateStats, 1000);
    </script>
</body>
</html>